<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoodleBeats - Turn Your Drawings into Music</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6C63FF',
            secondary: '#00F5D4',
            accent: '#FF6584',
            dark: '#2A2A45',
            light: '#F7F7FF'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .brush-active {
        @apply ring-2 ring-accent scale-110;
      }
      .canvas-grid {
        background-size: 20px 20px;
        background-image: 
          linear-gradient(to right, rgba(108, 99, 255, 0.05) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(108, 99, 255, 0.05) 1px, transparent 1px);
      }
      .glow {
        filter: drop-shadow(0 0 8px rgba(108, 99, 255, 0.6));
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    }
  </style>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="font-inter bg-gradient-to-br from-dark to-dark/90 text-light min-h-screen flex flex-col">
  <!-- 顶部导航 -->
  <header class="py-4 px-6 md:px-12 flex justify-between items-center bg-dark/50 backdrop-blur-md border-b border-primary/20">
    <div class="flex items-center gap-2">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
        <i class="fa fa-music text-white text-xl"></i>
      </div>
      <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">DoodleBeats</h1>
    </div>
    
    <div class="flex items-center gap-4">
      <button id="clearBtn" class="px-4 py-2 rounded-full bg-dark/80 border border-primary/30 hover:border-primary transition-all flex items-center gap-2">
        <i class="fa fa-eraser"></i>
        <span class="hidden sm:inline">Clear</span>
      </button>
      <button id="saveBtn" class="px-4 py-2 rounded-full bg-primary/20 border border-primary/50 hover:bg-primary/30 transition-all flex items-center gap-2">
        <i class="fa fa-download"></i>
        <span class="hidden sm:inline">Save</span>
      </button>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 px-4 md:px-12 py-8 max-w-7xl mx-auto w-full">
    <div class="mb-8 text-center">
      <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-semibold mb-2">Draw Your Sound</h2>
      <p class="text-light/70 max-w-2xl mx-auto">Create music by drawing! Each brush creates a different sound loop. Draw patterns and turn them into unique audio.</p>
    </div>
    
    <!-- 画笔选择区 -->
    <div class="mb-8">
      <h3 class="text-lg font-medium mb-4 flex items-center gap-2">
        <i class="fa fa-paint-brush text-primary"></i>
        Different Loop Brushes
      </h3>
      <div id="brushSelection" class="flex flex-wrap gap-3 md:gap-4 justify-center">
        <!-- 画笔选项 -->
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="kick">
          <div class="w-6 h-6 rounded-full bg-primary/80"></div>
        </div>
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="snare">
          <div class="w-6 h-2 rounded-full bg-secondary/80"></div>
        </div>
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="hihat">
          <div class="w-5 h-5 border-2 border-accent/80 rounded-full"></div>
        </div>
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="bass">
          <div class="w-6 h-6 flex flex-col justify-between">
            <div class="w-full h-1 bg-primary/80 rounded"></div>
            <div class="w-full h-1 bg-primary/80 rounded"></div>
            <div class="w-full h-1 bg-primary/80 rounded"></div>
          </div>
        </div>
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="melody">
          <div class="w-6 h-6 flex flex-col justify-between">
            <div class="w-full h-1 bg-secondary/80 rounded" style="width: 30%"></div>
            <div class="w-full h-1 bg-secondary/80 rounded" style="width: 70%"></div>
            <div class="w-full h-1 bg-secondary/80 rounded" style="width: 50%"></div>
            <div class="w-full h-1 bg-secondary/80 rounded" style="width: 90%"></div>
          </div>
        </div>
        <div class="brush-option cursor-pointer w-12 h-12 rounded-full bg-dark/60 border border-primary/30 flex items-center justify-center transition-all hover:scale-105" data-sound="effect">
          <div class="w-6 h-6 relative">
            <div class="absolute top-0 left-0 w-3 h-3 rounded-full bg-accent/80"></div>
            <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full bg-accent/80"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 绘图区域 -->
    <div class="mb-8 relative">
      <div class="bg-dark/40 rounded-xl p-1 md:p-2 border border-primary/20 shadow-lg shadow-primary/10">
        <canvas id="doodleCanvas" class="w-full rounded-lg canvas-grid cursor-crosshair"></canvas>
      </div>
      
      <!-- 音频可视化 -->
      <div id="audioVisualizer" class="hidden absolute top-0 left-0 w-full h-full bg-dark/30 rounded-lg backdrop-blur-sm flex items-center justify-center">
        <canvas id="visualizerCanvas" class="w-[80%] h-[60%]"></canvas>
      </div>
    </div>
    
    <!-- 控制按钮 -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
      <button id="convertBtn" class="px-8 py-4 rounded-full bg-gradient-to-r from-primary to-secondary text-dark font-semibold text-lg shadow-lg shadow-primary/20 hover:shadow-primary/30 transition-all transform hover:-translate-y-1 flex items-center gap-2">
        <i class="fa fa-magic"></i>
        Turn Drawing into Sound
      </button>
      
      <div id="audioControls" class="hidden items-center gap-4 bg-dark/60 rounded-full px-4 py-2 border border-primary/20">
        <button id="playBtn" class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center hover:bg-primary/30 transition-all">
          <i class="fa fa-play text-primary"></i>
        </button>
        <button id="pauseBtn" class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center hover:bg-primary/30 transition-all">
          <i class="fa fa-pause text-primary"></i>
        </button>
        <div class="w-32 md:w-48">
          <input type="range" id="volumeSlider" min="0" max="100" value="70" class="w-full accent-primary">
        </div>
      </div>
    </div>
  </main>
  
  <!-- 页脚 -->
  <footer class="py-6 px-6 md:px-12 border-t border-primary/20 bg-dark/50 backdrop-blur-md text-center text-light/60 text-sm">
    <p>DoodleBeats - Turn your creative drawings into amazing soundscapes</p>
    <p class="mt-2">Created with <i class="fa fa-heart text-accent"></i> using Web Audio API</p>
  </footer>

  <script>
    // DOM元素
    const canvas = document.getElementById('doodleCanvas');
    const ctx = canvas.getContext('2d');
    const visualizerCanvas = document.getElementById('visualizerCanvas');
    const visualizerCtx = visualizerCanvas.getContext('2d');
    const brushOptions = document.querySelectorAll('.brush-option');
    const convertBtn = document.getElementById('convertBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');
    const audioControls = document.getElementById('audioControls');
    const audioVisualizer = document.getElementById('audioVisualizer');
    
    // 应用状态
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let selectedBrush = 'kick';
    let drawingData = [];
    let audioContext;
    let oscillators = [];
    let analyser;
    let animationId;
    
    // 设置Canvas尺寸
    function resizeCanvas() {
      const container = canvas.parentElement;
      canvas.width = container.clientWidth;
      canvas.height = Math.min(500, window.innerHeight * 0.5);
      
      visualizerCanvas.width = visualizerCanvas.clientWidth;
      visualizerCanvas.height = visualizerCanvas.clientHeight;
      
      // 重绘
      redrawCanvas();
    }
    
    // 初始化Canvas
    function initCanvas() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // 绘图事件
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // 触摸设备支持
      canvas.addEventListener('touchstart', startDrawingTouch);
      canvas.addEventListener('touchmove', drawTouch);
      canvas.addEventListener('touchend', stopDrawing);
      
      // 初始清空
      clearCanvas();
    }
    
    // 重绘Canvas
    function redrawCanvas() {
      clearCanvas();
      
      drawingData.forEach(stroke => {
        drawStroke(stroke);
      });
    }
    
    // 清除Canvas
    function clearCanvas() {
      ctx.fillStyle = 'rgba(42, 42, 69, 0.8)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    // 开始绘图
    function startDrawing(e) {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    // 触摸开始绘图
    function startDrawingTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      isDrawing = true;
      [lastX, lastY] = [x, y];
    }
    
    // 绘图
    function draw(e) {
      if (!isDrawing) return;
      
      const stroke = {
        x1: lastX,
        y1: lastY,
        x2: e.offsetX,
        y2: e.offsetY,
        brush: selectedBrush,
        timestamp: Date.now()
      };
      
      drawingData.push(stroke);
      drawStroke(stroke);
      
      [lastX, lastY] = [e.offsetX, e.offsetY];
    }
    
    // 触摸绘图
    function drawTouch(e) {
      if (!isDrawing) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      const stroke = {
        x1: lastX,
        y1: lastY,
        x2: x,
        y2: y,
        brush: selectedBrush,
        timestamp: Date.now()
      };
      
      drawingData.push(stroke);
      drawStroke(stroke);
      
      [lastX, lastY] = [x, y];
    }
    
    // 停止绘图
    function stopDrawing() {
      isDrawing = false;
    }
    
    // 绘制单条线段
    function drawStroke(stroke) {
      ctx.beginPath();
      ctx.moveTo(stroke.x1, stroke.y1);
      ctx.lineTo(stroke.x2, stroke.y2);
      
      // 根据画笔类型设置样式
      switch(stroke.brush) {
        case 'kick':
          ctx.strokeStyle = '#6C63FF';
          ctx.lineWidth = 4;
          break;
        case 'snare':
          ctx.strokeStyle = '#00F5D4';
          ctx.lineWidth = 3;
          break;
        case 'hihat':
          ctx.strokeStyle = '#FF6584';
          ctx.lineWidth = 2;
          break;
        case 'bass':
          ctx.strokeStyle = '#6C63FF80';
          ctx.lineWidth = 6;
          break;
        case 'melody':
          ctx.strokeStyle = '#00F5D480';
          ctx.lineWidth = 4;
          break;
        case 'effect':
          ctx.strokeStyle = '#FF658480';
          ctx.lineWidth = 3;
          ctx.setLineDash([5, 5]);
          break;
      }
      
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.stroke();
      
      // 重置虚线设置
      ctx.setLineDash([]);
    }
    
    // 初始化画笔选择
    function initBrushes() {
      // 默认选中第一个画笔
      brushOptions[0].classList.add('brush-active', 'glow');
      
      brushOptions.forEach(brush => {
        brush.addEventListener('click', () => {
          // 移除其他画笔的选中状态
          brushOptions.forEach(b => b.classList.remove('brush-active', 'glow'));
          
          // 添加当前画笔的选中状态
          brush.classList.add('brush-active', 'glow');
          
          // 更新选中的画笔
          selectedBrush = brush.dataset.sound;
        });
      });
    }
    
    // 初始化音频
    function initAudio() {
      try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.connect(audioContext.destination);
      } catch (e) {
        console.error('Web Audio API is not supported in this browser');
        alert('Web Audio API is not supported in this browser');
      }
    }
    
    // 根据绘图数据创建音频
    function createAudioFromDrawing() {
      if (!audioContext) {
        initAudio();
      } else if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      // 停止任何正在播放的音频
      stopAudio();
      
      // 根据绘图数据创建音频
      const soundGroups = {};
      
      // 按画笔类型分组
      drawingData.forEach(stroke => {
        if (!soundGroups[stroke.brush]) {
          soundGroups[stroke.brush] = [];
        }
        soundGroups[stroke.brush].push(stroke);
      });
      
      // 为每组画笔创建音频
      Object.keys(soundGroups).forEach(brushType => {
        createSoundForBrush(brushType, soundGroups[brushType]);
      });
      
      // 显示音频控制
      audioControls.classList.remove('hidden');
      audioControls.classList.add('flex');
      
      // 显示可视化
      if (Object.keys(soundGroups).length > 0) {
        audioVisualizer.classList.remove('hidden');
        visualizeAudio();
      }
      
      // 添加转换动画效果
      convertBtn.classList.add('animate-pulse-slow');
      setTimeout(() => {
        convertBtn.classList.remove('animate-pulse-slow');
      }, 1000);
    }
    
    // 为特定画笔类型创建声音
    function createSoundForBrush(brushType, strokes) {
      // 根据画笔类型和绘图数据创建不同的声音
      const gainNode = audioContext.createGain();
      gainNode.connect(analyser);
      
      let oscillator;
      let frequency = 220; // 基础频率
      let volume = 0.5;
      
      // 根据画笔类型设置不同的声音特性
      switch(brushType) {
        case 'kick':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'sine';
          frequency = 60 + (strokes.length % 5) * 10;
          break;
        case 'snare':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'square';
          frequency = 180 + (strokes.length % 7) * 15;
          break;
        case 'hihat':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'triangle';
          frequency = 800 + (strokes.length % 10) * 50;
          volume = 0.3;
          break;
        case 'bass':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'sine';
          frequency = 55 + (strokes.length % 4) * 15;
          break;
        case 'melody':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'sawtooth';
          frequency = 440 + (strokes.length % 12) * 30;
          break;
        case 'effect':
          oscillator = audioContext.createOscillator();
          oscillator.type = 'noise'; // 实际中需要特殊处理噪声
          frequency = 1000 + (strokes.length % 8) * 100;
          volume = 0.2;
          break;
      }
      
      // 设置频率和音量
      oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
      gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
      
      // 根据绘图的复杂度设置不同的节奏/调制
      const complexity = Math.min(1, strokes.length / 50);
      
      if (brushType !== 'effect') {
        // 创建频率调制，使声音更有趣
        const modulator = audioContext.createOscillator();
        const modGain = audioContext.createGain();
        
        modulator.type = 'sine';
        modulator.frequency.setValueAtTime(0.5 + complexity * 4, audioContext.currentTime);
        modGain.gain.setValueAtTime(5 + complexity * 30, audioContext.currentTime);
        
        modulator.connect(modGain);
        modGain.connect(oscillator.frequency);
        modulator.start();
        
        oscillators.push(modulator);
      }
      
      // 连接并开始播放
      oscillator.connect(gainNode);
      oscillator.start();
      
      // 存储振荡器以便后续控制
      oscillators.push({
        oscillator,
        gainNode,
        type: brushType
      });
    }
    
    // 播放音频
    function playAudio() {
      if (!audioContext) return;
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      oscillators.forEach(osc => {
        if (osc.gainNode) {
          osc.gainNode.gain.setValueAtTime(osc.gainNode.gain.value, audioContext.currentTime);
        }
      });
    }
    
    // 暂停音频
    function pauseAudio() {
      if (!audioContext || audioContext.state === 'suspended') return;
      
      oscillators.forEach(osc => {
        if (osc.gainNode) {
          osc.gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        }
      });
    }
    
    // 停止音频
    function stopAudio() {
      if (!audioContext) return;
      
      oscillators.forEach(osc => {
        if (osc.oscillator) {
          osc.oscillator.stop();
          osc.oscillator.disconnect();
        }
        if (osc.gainNode) {
          osc.gainNode.disconnect();
        }
      });
      
      oscillators = [];
      
      // 停止可视化
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }
    
    // 可视化音频
    function visualizeAudio() {
      if (!analyser) return;
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      function drawVisualizer() {
        animationId = requestAnimationFrame(drawVisualizer);
        
        analyser.getByteFrequencyData(dataArray);
        
        const width = visualizerCanvas.width;
        const height = visualizerCanvas.height;
        
        visualizerCtx.fillStyle = 'rgba(42, 42, 69, 0.3)';
        visualizerCtx.fillRect(0, 0, width, height);
        
        const barWidth = (width / bufferLength) * 2.5;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * height;
          
          // 根据频率设置不同颜色
          let hue = (i / bufferLength) * 360;
          visualizerCtx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
          
          visualizerCtx.fillRect(x, height - barHeight, barWidth, barHeight);
          
          x += barWidth + 1;
        }
      }
      
      drawVisualizer();
    }
    
    // 保存绘图
    function saveDrawing() {
      if (drawingData.length === 0) {
        alert('Nothing to save! Create a drawing first.');
        return;
      }
      
      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = `doodle-beats-${new Date().getTime()}.png`;
      link.href = dataURL;
      link.click();
    }
    
    // 事件监听
    function setupEventListeners() {
      // 转换按钮
      convertBtn.addEventListener('click', createAudioFromDrawing);
      
      // 音频控制
      playBtn.addEventListener('click', playAudio);
      pauseBtn.addEventListener('click', pauseAudio);
      
      // 音量控制
      volumeSlider.addEventListener('input', (e) => {
        const volume = e.target.value / 100;
        oscillators.forEach(osc => {
          if (osc.gainNode) {
            osc.gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
          }
        });
      });
      
      // 清除按钮
      clearBtn.addEventListener('click', () => {
        stopAudio();
        drawingData = [];
        clearCanvas();
        audioControls.classList.add('hidden');
        audioControls.classList.remove('flex');
        audioVisualizer.classList.add('hidden');
      });
      
      // 保存按钮
      saveBtn.addEventListener('click', saveDrawing);
    }
    
    // 初始化应用
    function initApp() {
      initCanvas();
      initBrushes();
      initAudio();
      setupEventListeners();
    }
    
    // 启动应用
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>